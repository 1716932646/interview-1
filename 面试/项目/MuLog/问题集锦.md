### 日志相关

### 说下你的日志系统的运行机制？

——初始化服务器时，利用单例模式初始化日志系统，根据配置文件确认是同步还是异步写入的方式。

### 为什么要异步？和同步的区别是什么？

——同步方式写入日志时，每次调用一次打印日志API就对应一次系统调用write写日志文件。

如果日志打印很频繁，

* 大量的日志打印陷入等量的write**系统调用**，有一定系统开销。

* 另一方面，使得打印日志的进程附带了大量**同步的磁盘IO**，影响性能



若是某条日志信息过大，

* 会**阻塞**日志系统，造成系统瓶颈。



异步方式按我的理解就是主线程的日志打印接口仅负责生产日志数据（作为日志的生产者），而日志的落地操作留给另一个后台线程去完成（作为日志的消费者），这是一个典型的**生产者-消费者**问题。



主线程调用日志打印接口成为**非阻塞操作**，同步的磁盘IO从主线程中剥离出来，有助于提高性能。

对于异步日志，我们很容易借助**队列**来一个实现方式：主线程写日志到队列，队列本身使用条件变量、或者管道、eventfd等通知机制，**当有数据入队列就通知消费者线程去消费日志**。

但是，这样的异步队列也有一定的问题：

* 生产者线程产生N个日志，对应后台线程就会被通知N次，频繁日志写入会造成一定性能开销
* 不同队列实现方式也各有缺点： 
  * 用数组实现：空间不足时，队列内存不易拓展
  * 用链表实现：每条消息的生产消费都对应内存的创建销毁，有一定开销



### 说说你的日志系统动态缓冲区+双循环链表的设计

**一句话介绍原理**：
使用多个大数组缓冲区作为日志缓冲区，多个大数组缓冲区`cell_buffer`以双向循环链表方式连接，并使用两个指针`Producer Ptr`和`Consumer Ptr`指向链表两个节点，分别用以生成数据、与消费数据 

生产者可以是多线程，共同持有`Producer Ptr`来生产数据，消费者是一个后台线程，持有`Consumer Ptr`去消费数据

**大数组缓冲区 + 双循环链表的设计，使得日志缓冲区相比于队列有更强大的拓展能力、且避免了大量内存申请释放，提高了异步日志在海量日志生成下的性能表现**。









### 性能测试



#### 1. 单线程连续写1亿条日志的效率

写1亿条日志（每条日志长度为100字节）测试调用总耗时，测5次，结果如下：

| 方式  |  第1次  |  第2次  |  第3次  |  第4次  |  第5次  |  平均  |   速度/s   |
| :---: | :-----: | :-----: | :-----: | :-----: | :-----: | :----: | :--------: |
| MuLog | 79.816s | 78.694s | 79.489s | 79.731s | 79.220s | 79.39s | 125.96万/s |

**每秒127万条**长为*100字节*的日志的写入

#### 2、多线程各写1千万条日志的效率

开5个线程各写1千万条日志（每条日志长度为100字节）测试调用总耗时，测5次，结果如下：

| 方式  |  第1次  |  第2次  |  第3次  |  第4次  |  第5次  |  平均   |   速度/s   |
| ----- | :-----: | :-----: | :-----: | :-----: | :-----: | :-----: | :--------: |
| MuLog | 36.896s | 37.011s | 38.524s | 37.197s | 38.034s | 37.532s | 133.22万/s |

多线程（5线程）运行下，`MuLog`写日志效率是传统同步日志的近`3.8`倍，可以达到**每秒135.5万条**长为*100字节*的日志的写入



 QPS每秒查询率(Query Per Second) 
　　每秒查询率QPS是对一个特定的查询服务器在规定时间内所处理流量多少的衡量标准，在因特网上，作为域名系统服务器的机器的性能经常用每秒查询率来衡量。对应fetches/sec，即**每秒的响应请求数**，也即是最大吞吐能力。



#### 2. 对server QPS的影响

现有一个Reactor模式实现的echo Server（基于Muluo），其纯净的QPS大致为`19.32万/s`
现在分别使用`MuLog`来测试：echo Server在每收到一个数据就调用一次日志打印下的QPS表现

采集12次实时QPS，统计后大致结果如下：

|   方式   | 最低QPS  | 最高QPS  | 平均QPS  | QPS损失比 |
| :------: | :------: | :------: | :------: | :-------: |
| ` MuLog` | 154979次 | 178697次 | 167198次 |  13.46%   |

>传统同步日志损失了`40%`左右
>`MuLog`使得echo Server QPS从19.32w万/s降低至`16.72万/s`，损失了`13.46%`





### 现在你要监控一台服务器的状态，输出监控日志，请问如何将该日志分发到不同的机器上？（消息队列）

——为了便于故障排查，或服务器状态分析，看是否需要维护；可以使用消息队列进行消息的分发，例如mqtt、rabitmq等等；